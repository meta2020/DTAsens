
<!-- README.md is generated from README.Rmd. Please edit that file -->

# DTAsens

<!-- badges: start -->

<!-- badges: end -->

The goal of DTAsens is to conduct sensitivity analysis on DTA
meta-analysis

## Installation

You can install the released version of DTAsens from
[GitHub](https://github.com/meta2020/DTAsens) with:

``` r
devtools::install_git("meta2020/DTAsens")
```

## Example

This is an example which shows you how to solve a common problem:

``` r
library(DTAsens)

data(IVD)
kable(head(IVD))
```

| study | TP | FN |  FP |  TN |
| ----: | -: | -: | --: | --: |
|     1 | 12 |  0 |  29 | 289 |
|     2 | 10 |  2 |  14 |  72 |
|     3 | 17 |  1 |  36 |  85 |
|     4 | 13 |  0 |  18 |  67 |
|     5 |  4 |  0 |  21 | 225 |
|     6 | 15 |  2 | 122 | 403 |

### Optim 1: dtasens1

For a certain selection probability, e.g., p = 0.7

``` r
dtasens1(IVD, p = 0.7)
#> $par
#>     u1     u2     t1     t2      r    t12      b      a    c11    c22    auc 
#>  1.380  1.740  0.596  0.845 -0.354 -0.178  2.000 -4.290  0.500  0.500  0.851 
#>     se     sp 
#>  0.799  0.851 
#> 
#> $value
#> [1] 22.9
#> 
#> $counts
#> function gradient 
#>       18       18 
#> 
#> $convergence
#> [1] 0
#> 
#> $message
#> [1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
#> 
#> $prof.llk.ci
#>    ci.low estimate ci.up
#> u1  1.081    1.380  1.67
#> u2  1.459    1.740  2.02
#> t1  0.303    0.596  1.01
#> t2  0.645    0.845  1.15
#> r  -0.748   -0.354  0.15
#> b   0.972    2.000    NA

dtasens1(IVD, p = 0.7, 
         show.p.hat = TRUE, show.auc.all = TRUE, show.data = TRUE)
#> $data
#>     sens  spec     y1    y2     v1      v2 ldor.t
#> 1  0.962 0.908  3.219 2.284 2.0800 0.03735   3.78
#> 2  0.833 0.837  1.609 1.638 0.6000 0.08532   3.92
#> 3  0.944 0.702  2.833 0.859 1.0588 0.03954   3.52
#> 4  0.964 0.785  3.296 1.294 2.0741 0.06887   3.14
#> 5  0.900 0.913  2.197 2.350 2.2222 0.05095   3.02
#> 6  0.882 0.768  2.015 1.195 0.5667 0.01068   4.22
#> 7  0.900 0.548  2.197 0.194 0.2222 0.06513   4.46
#> 8  0.818 0.658  1.504 0.656 0.3056 0.02201   3.77
#> 9  0.917 0.750  2.398 1.099 2.1818 0.11594   2.31
#> 10 0.471 0.865 -0.118 1.856 0.2361 0.07708   3.11
#> 11 0.917 0.894  2.398 2.136 2.1818 0.14908   2.97
#> 12 0.846 0.833  1.705 1.609 0.5909 0.00984   4.28
#> 13 0.833 0.960  1.609 3.185 1.2000 0.17356   4.09
#> 14 0.583 0.932  0.336 2.616 0.3429 0.04292   4.75
#> 15 0.909 0.761  2.303 1.158 1.1000 0.01413   3.28
#> 16 0.500 0.869  0.000 1.889 0.4000 0.02808   2.89
#> 17 0.917 0.775  2.398 1.239 2.1818 0.08321   2.42
#> 18 0.809 0.980  1.442 3.872 0.0951 0.05373  13.78
#> 19 0.750 0.714  1.099 0.916 0.6667 0.11667   2.28
#> 20 0.618 0.980  0.480 3.872 0.0623 0.05373  12.78
#> 21 0.625 0.881  0.511 2.001 0.5333 0.22703   2.88
#> 22 0.964 0.916  3.296 2.390 2.0741 0.09492   3.86
#> 23 0.976 0.921  3.714 2.463 2.0488 0.04429   4.27
#> 24 0.538 0.847  0.154 1.712 0.3095 0.09081   2.95
#> 25 0.960 0.758  3.178 1.142 0.5208 0.08794   5.54
#> 26 0.917 0.837  2.398 1.638 1.0909 0.08532   3.72
#> 27 0.750 0.842  1.099 1.670 0.2667 0.03713   5.02
#> 28 0.840 0.688  1.655 0.788 0.0916 0.29091   3.95
#> 29 0.929 0.935  2.565 2.667 1.0769 0.21389   4.61
#> 30 0.727 0.830  0.981 1.588 0.4583 0.01825   3.72
#> 31 0.929 0.749  2.565 1.095 1.0769 0.01362   3.50
#> 32 0.906 0.997  2.269 5.740 0.7356 2.00643   4.84
#> 33 0.800 0.938  1.386 2.708 0.6250 0.26667   4.34
#> 
#> $optim
#> $optim$par
#>     u1     u2     t1     t2      r    t12      b      a    c11    c22    auc 
#>  1.380  1.740  0.596  0.845 -0.354 -0.178  2.000 -4.290  0.500  0.500  0.851 
#>     se     sp  p.hat 
#>  0.799  0.851  0.700 
#> 
#> $optim$value
#> [1] 22.9
#> 
#> $optim$counts
#> function gradient 
#>       18       18 
#> 
#> $optim$convergence
#> [1] 0
#> 
#> $optim$message
#> [1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
#> 
#> $optim$prof.llk.ci
#>    ci.low estimate ci.up
#> u1  1.081    1.380  1.67
#> u2  1.459    1.740  2.02
#> t1  0.303    0.596  1.01
#> t2  0.645    0.845  1.15
#> r  -0.748   -0.354  0.15
#> b   0.972    2.000    NA
#> 
#> $optim$auc
#> 0.851 with absolute error < 1.1e-06
```

For a series of selection probabilities, e.g., p = 0.9, 0,8, …,0.1

``` r
p.seq <- seq(1, 0.1, -0.1)

estimates <- sapply(p.seq, 
                    function(p) dtasens1(IVD, p, 
                                         b.interval = c(0,2), 
                                         a.interval = c(-3,3), 
                                         a.root.extendInt = "downX")$par)

colnames(estimates)<- paste0("p = ", p.seq)
kable(estimates)
```

|     |   p = 1 | p = 0.9 | p = 0.8 | p = 0.7 | p = 0.6 | p = 0.5 | p = 0.4 | p = 0.3 | p = 0.2 | p = 0.1 |
| :-- | ------: | ------: | ------: | ------: | ------: | ------: | ------: | ------: | ------: | ------: |
| u1  |   1.484 |   1.478 |   1.442 |   1.380 |   1.301 |   1.207 |   1.091 |   0.933 |   0.704 |   0.280 |
| u2  |   1.824 |   1.819 |   1.791 |   1.740 |   1.671 |   1.581 |   1.464 |   1.299 |   1.054 |   0.610 |
| t1  |   0.597 |   0.599 |   0.600 |   0.596 |   0.592 |   0.594 |   0.605 |   0.634 |   0.688 |   0.793 |
| t2  |   0.826 |   0.828 |   0.835 |   0.845 |   0.857 |   0.873 |   0.897 |   0.933 |   0.986 |   1.077 |
| r   | \-0.424 | \-0.415 | \-0.388 | \-0.354 | \-0.310 | \-0.254 | \-0.176 | \-0.068 |   0.071 |   0.256 |
| t12 | \-0.209 | \-0.206 | \-0.194 | \-0.178 | \-0.158 | \-0.132 | \-0.096 | \-0.040 |   0.048 |   0.218 |
| b   |   0.100 |   2.000 |   2.000 |   2.000 |   2.000 |   2.000 |   2.000 |   2.000 |   1.930 |   1.820 |
| a   |  10.650 | \-2.553 | \-3.636 | \-4.290 | \-4.757 | \-5.123 | \-5.425 | \-5.679 | \-5.729 | \-5.664 |
| c11 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |
| c22 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |
| auc |   0.874 |   0.872 |   0.864 |   0.851 |   0.834 |   0.810 |   0.778 |   0.729 |   0.657 |   0.540 |
| se  |   0.815 |   0.814 |   0.809 |   0.799 |   0.786 |   0.770 |   0.749 |   0.718 |   0.669 |   0.570 |
| sp  |   0.861 |   0.860 |   0.857 |   0.851 |   0.842 |   0.829 |   0.812 |   0.786 |   0.742 |   0.648 |

### Optim 2: dtasens2

For a certain selection probability, e.g., p = 0.7

``` r

dtasens2(IVD, p = 0.7)
#> $par
#>     u1     u2     t1     t2      r    t12      b      a    c11    c22    auc 
#>  1.379  1.741  0.596  0.844 -0.353 -0.178  2.000 -4.254  0.509  0.491  0.851 
#>     se     sp 
#>  0.799  0.851 
#> 
#> $value
#> [1] 22.9
#> 
#> $counts
#> function gradient 
#>       19       19 
#> 
#> $convergence
#> [1] 0
#> 
#> $message
#> [1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
#> 
#> $prof.llk.ci
#>    ci.low estimate ci.up
#> u1  1.079    1.379 1.672
#> u2  1.460    1.741 2.018
#> t1  0.303    0.596 1.009
#> t2  0.645    0.844 1.149
#> r  -0.748   -0.353 0.150
#> b   0.977    2.000    NA
#> c1  0.418    0.714 0.918
#> 
#> attr(,"class")
#> [1] "DTAsens2"

dtasens2(IVD, p = 0.7, 
         show.p.hat = TRUE, show.auc.all = TRUE, show.data = TRUE)
#> $data
#>     sens  spec     y1    y2     v1      v2 ldor.t
#> 1  0.962 0.908  3.219 2.284 2.0800 0.03735   3.78
#> 2  0.833 0.837  1.609 1.638 0.6000 0.08532   3.92
#> 3  0.944 0.702  2.833 0.859 1.0588 0.03954   3.52
#> 4  0.964 0.785  3.296 1.294 2.0741 0.06887   3.14
#> 5  0.900 0.913  2.197 2.350 2.2222 0.05095   3.02
#> 6  0.882 0.768  2.015 1.195 0.5667 0.01068   4.22
#> 7  0.900 0.548  2.197 0.194 0.2222 0.06513   4.46
#> 8  0.818 0.658  1.504 0.656 0.3056 0.02201   3.77
#> 9  0.917 0.750  2.398 1.099 2.1818 0.11594   2.31
#> 10 0.471 0.865 -0.118 1.856 0.2361 0.07708   3.11
#> 11 0.917 0.894  2.398 2.136 2.1818 0.14908   2.97
#> 12 0.846 0.833  1.705 1.609 0.5909 0.00984   4.28
#> 13 0.833 0.960  1.609 3.185 1.2000 0.17356   4.09
#> 14 0.583 0.932  0.336 2.616 0.3429 0.04292   4.75
#> 15 0.909 0.761  2.303 1.158 1.1000 0.01413   3.28
#> 16 0.500 0.869  0.000 1.889 0.4000 0.02808   2.89
#> 17 0.917 0.775  2.398 1.239 2.1818 0.08321   2.42
#> 18 0.809 0.980  1.442 3.872 0.0951 0.05373  13.78
#> 19 0.750 0.714  1.099 0.916 0.6667 0.11667   2.28
#> 20 0.618 0.980  0.480 3.872 0.0623 0.05373  12.78
#> 21 0.625 0.881  0.511 2.001 0.5333 0.22703   2.88
#> 22 0.964 0.916  3.296 2.390 2.0741 0.09492   3.86
#> 23 0.976 0.921  3.714 2.463 2.0488 0.04429   4.27
#> 24 0.538 0.847  0.154 1.712 0.3095 0.09081   2.95
#> 25 0.960 0.758  3.178 1.142 0.5208 0.08794   5.54
#> 26 0.917 0.837  2.398 1.638 1.0909 0.08532   3.72
#> 27 0.750 0.842  1.099 1.670 0.2667 0.03713   5.02
#> 28 0.840 0.688  1.655 0.788 0.0916 0.29091   3.95
#> 29 0.929 0.935  2.565 2.667 1.0769 0.21389   4.61
#> 30 0.727 0.830  0.981 1.588 0.4583 0.01825   3.72
#> 31 0.929 0.749  2.565 1.095 1.0769 0.01362   3.50
#> 32 0.906 0.997  2.269 5.740 0.7356 2.00643   4.84
#> 33 0.800 0.938  1.386 2.708 0.6250 0.26667   4.34
#> 
#> $opt
#> $par
#>     u1     u2     t1     t2      r    t12      b      a    c11    c22    auc 
#>  1.379  1.741  0.596  0.844 -0.353 -0.178  2.000 -4.254  0.509  0.491  0.851 
#>     se     sp  p.hat 
#>  0.799  0.851  0.700 
#> 
#> $value
#> [1] 22.9
#> 
#> $counts
#> function gradient 
#>       19       19 
#> 
#> $convergence
#> [1] 0
#> 
#> $message
#> [1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
#> 
#> $prof.llk.ci
#>    ci.low estimate ci.up
#> u1  1.079    1.379 1.672
#> u2  1.460    1.741 2.018
#> t1  0.303    0.596 1.009
#> t2  0.645    0.844 1.149
#> r  -0.748   -0.353 0.150
#> b   0.977    2.000    NA
#> c1  0.418    0.714 0.918
#> 
#> $auc
#> 0.851 with absolute error < 1.1e-06
#> 
#> attr(,"class")
#> [1] "DTAsens2"
```

For a series of selection probabilities, e.g., p = 0.9, 0.8, …,0.1

``` r
p.seq <- seq(1, 0.1, -0.1)

estimates <- sapply(p.seq, 
                    function(p) dtasens1(IVD, p, 
                                         b.interval = c(0,2), 
                                         a.interval = c(-3,2), 
                                         a.root.extendInt = "downX")$par)

colnames(estimates)<- paste0("p = ", p.seq)
kable(estimates)
```

|     |   p = 1 | p = 0.9 | p = 0.8 | p = 0.7 | p = 0.6 | p = 0.5 | p = 0.4 | p = 0.3 | p = 0.2 | p = 0.1 |
| :-- | ------: | ------: | ------: | ------: | ------: | ------: | ------: | ------: | ------: | ------: |
| u1  |   1.484 |   1.478 |   1.442 |   1.380 |   1.301 |   1.207 |   1.091 |   0.933 |   0.704 |   0.280 |
| u2  |   1.824 |   1.819 |   1.791 |   1.740 |   1.671 |   1.581 |   1.464 |   1.299 |   1.054 |   0.610 |
| t1  |   0.597 |   0.599 |   0.600 |   0.596 |   0.592 |   0.594 |   0.605 |   0.634 |   0.688 |   0.793 |
| t2  |   0.826 |   0.828 |   0.835 |   0.845 |   0.857 |   0.873 |   0.897 |   0.933 |   0.986 |   1.077 |
| r   | \-0.424 | \-0.415 | \-0.388 | \-0.354 | \-0.310 | \-0.254 | \-0.176 | \-0.068 |   0.071 |   0.256 |
| t12 | \-0.209 | \-0.206 | \-0.195 | \-0.178 | \-0.158 | \-0.132 | \-0.096 | \-0.040 |   0.048 |   0.218 |
| b   |   0.100 |   2.000 |   2.000 |   2.000 |   2.000 |   2.000 |   2.000 |   2.000 |   1.930 |   1.820 |
| a   |  12.220 | \-2.553 | \-3.636 | \-4.290 | \-4.757 | \-5.123 | \-5.425 | \-5.679 | \-5.728 | \-5.664 |
| c11 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |
| c22 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |   0.500 |
| auc |   0.874 |   0.872 |   0.864 |   0.851 |   0.834 |   0.810 |   0.778 |   0.729 |   0.657 |   0.540 |
| se  |   0.815 |   0.814 |   0.809 |   0.799 |   0.786 |   0.770 |   0.749 |   0.718 |   0.669 |   0.570 |
| sp  |   0.861 |   0.860 |   0.857 |   0.851 |   0.842 |   0.829 |   0.812 |   0.786 |   0.742 |   0.648 |

### Plot ROC

One ROC

``` r
par(mfrow = c(1,2))

library(mada)
#> Loading required package: mvtnorm
#> Loading required package: ellipse
#> 
#> Attaching package: 'ellipse'
#> The following object is masked from 'package:graphics':
#> 
#>     pairs
#> Loading required package: mvmeta
#> This is mvmeta 1.0.3. For an overview type: help('mvmeta-package').
fit <- reitsma(IVD, correction.control = "single", method = "ml")
plot(fit)
title("Reistma model from mada")


par0 <- c(fit$coefficients*c(1,-1), c(1,-1)*sqrt(fit$Psi[c(1,4)]), fit$Psi[3]/prod(sqrt(fit$Psi[c(1,4)])))

par1 <- dtasens1(IVD, 0.7)$par
par2 <- dtasens2(IVD, 0.7)$par

sROC(par1, pch = 19, add.ci = FALSE)
sROC(par2, add = TRUE, col=2, pch = 19, add.ci = FALSE)
sROC(par0, add = TRUE, col=3, pch = 4, add.ci = FALSE)

with(IVD, points(FP/(FP+TN), TP/(TP+FN), pch = 4, cex = 0.5))
legend("bottomright", c("dtasens1", "dtasens2", "Reistma", "data"), col = c(1,2,3, 1), lty = c(1,1,1, 0), pch = c(19,19,4, 4))
title("When selection prob = 0.7")
```

<img src="man/figures/README-unnamed-chunk-7-1.png" width="100%" />

``` r
par(mfrow = c(1,1))
```

A series of ROC

``` r

p.seq <- seq(1, 0.1, -0.1)
estimates1 <- sapply(p.seq, 
                     function(p) dtasens1(IVD, p,
                                          b.interval = c(0,2),
                                          a.interval = c(-3,2))$par)
estimates2 <- sapply(p.seq, 
                     function(p) dtasens2(IVD, p,
                                          b.interval = c(0,2),
                                          a.interval = c(-3,2))$par)

par(mfrow = c(1,2))
mROC(par.matrix = estimates1)
sROC(par0, add = TRUE, col = 2, pch = 19, lty =3)
title("dtasens1")

mROC(par.matrix = estimates2, p.vec = p.seq)
sROC(par0, add = TRUE, col = 2, pch = 19, lty =3)
title("dtasens2")
```

<img src="man/figures/README-unnamed-chunk-8-1.png" width="100%" />

``` r
par(mfrow = c(1,1))
```
